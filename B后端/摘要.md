# 摘要

摘要

单个Redis服务器可能会面临以下问题：数据量过大，超过单机内存的限制；读写压力过大，导致性能下降或服务不可用；单点故障导致数据丢失或服务中断。为了解决这些问题，Redis提供了一些高可用性和高扩展性的解决方案，例如主从复制、哨兵模式和集群模式。本文将介绍如何配置Redis的主从复制和哨兵模式，以提高数据的可靠性和可用性。

主从复制

主从复制是一种数据备份和读写分离的机制，它可以让一台Redis服务器（主节点）的数据复制到其他的Redis服务器（从节点）。数据的复制是单向的，只能由主节点到从节点。主节点负责写入数据，从节点负责读取数据。主节点会将数据变化同步给从节点，从而保证数据的一致性。

主从复制有以下几个作用：

数据冗余：主从复制实现了数据的热备份，是持久化之外的一种数据冗余方式。

故障恢复：当主节点出现故障时，可以由从节点提供服务，实现快速的故障恢复。

负载均衡：在主从复制的基础上，配合读写分离，可以由主节点提供写服务，由从节点提供读服务（即写Redis数据时应用连接主节点，读Redis数据时应用连接从节点），分担服务器负载；尤其是在写少读多的场景下，通过多个从节点分担读负载，可以大大提高Redis服务器的并发量。

高可用基石：主从复制还是哨兵和集群能够实施的基础，因此说主从复制是Redis高可用的基础。

主从复制的配置

要配置主从复制，我们需要为每个Redis服务器准备一个配置文件，并修改以下参数：

# 1. 修改端口号，一主多从模式，此教程中我默认是以 6379 为主， 6380 、 6381 为从

port 6379

# 2. 开启守护进程模式运行，默认是no

daemonize yes 

# 3. 修改pid文件名，我是以端口来区分的

pidfile "/var/run/redis_6379.pid"

# 4. log文件名，以端口命名，放在log目录下

logfile "./log/6379.log"

# 5. dump.rdb 文件名，存储内存中的快照

dbfilename "dump_6379.rdb"

# dump文件的目录

dir "/usr/local/bin/redis/dump"

1

2

3

4

5

6

7

8

9

10

11

12

然后我们需要为每个Redis服务器启动服务，并指定配置文件。例如：

# 指定配置文件启动redis服务

./redis-server /etc/redis/m_s/redis-6379.conf

1

2

接下来我们需要在每个从服务器中指定要同步的主服务器。我们有三种方式：

在配置文件中添加slaveof 参数，并重启服务。

在启动服务时添加–slaveof 参数。

在运行时使用slaveof 命令。

例如，我们可以让6380和6381都成为6379的从节点，如下：

# 连接到6380

./redis-cli -p 6380

# 指定6379为主节点

slaveof 127.0.0.1 6379

# 查看主从状态

info replication

1

2

3

4

5

6

我们可以在主节点和从节点中使用info replication命令来查看主从复制的相关信息。如果看到role:master或role:slave，以及master_link_status:up，说明主从复制已经成功。

哨兵模式

哨兵模式是一种特殊的模式，首先Redis提供了哨兵的命令，哨兵是一个独立的进程，作为进程，它会独立运行。其原理就是哨兵通过发送命令，等到Redis服务器响应，从而监控运行的多个Redis实例。

哨兵的核心功能是主节点的自动故障转移。下面是Redis官方文档对于哨兵功能的描述：

监控（Monitoring）：哨兵会不断地检查主节点和从节点是否运作正常。

自动故障转移（Automatic Failover）：当主节点不能正常工作时，哨兵会开始自动故障转移操作，它会将失效主节点的其中一个从节点升级为新的主节点，并让其他从节点改为复制新的主节点。

配置提供者（Configuration Provider）：客户端在初始化时，通过连接哨兵来获得当前Redis服务的主节点地址。

通知（Notification）：哨兵可以将故障转移的结果发送给客户端。

哨兵模式的配置

哨兵模式的配置需要以下几个步骤：

配置主从节点：哨兵模式是基于主从复制的，所以首先需要配置好主从节点。主节点不需要做任何特殊的配置，只需要设置端口号、密码等基本参数。从节点需要指定要复制的主节点的地址和端口，以及主节点的密码。例如：

# 从节点的配置文件

port 6380

daemonize yes

logfile "6380.log"

dbfilename "dump-6380.rdb"

slaveof 127.0.0.1 6379 # 指定主节点

masterauth 123456 # 主节点密码

1

2

3

4

5

6

7

配置哨兵节点：哨兵节点是特殊的Redis进程，不存储数据，只负责监控和管理。哨兵节点需要指定要监控的主节点的地址和端口，以及最小投票数（即至少需要多少个哨兵同意才能判定主节点故障）。例如：

# 哨兵节点的配置文件

port 26379

daemonize yes

logfile "26379.log"

sentinel monitor mymaster 127.0.0.1 6379 2 # 监控主节点，名称为mymaster，最小投票数为2

sentinel auth-pass mymaster 123456 # 主节点密码

复制

启动主从节点：按照正常的方式启动主从节点，例如：

redis-server redis-6379.conf # 启动主节点

redis-server redis-6380.conf # 启动从节点

1

2

3

4

5

6

7

8

9

10

启动哨兵节点：使用redis-sentinel命令或者redis-server命令加上–sentinel参数来启动哨兵节点，例如：

redis-sentinel sentinel-26379.conf # 启动哨兵节点

1

哨兵节点不一定是在集群中所有服务器都要启动的，哨兵节点可以有多个，也可以只有一个，但是建议至少有三个，以避免单点故障。哨兵节点可以和数据节点部署在同一台服务器上，也可以部署在不同的服务器上，但是要保证哨兵节点和数据节点之间的网络通信畅通。哨兵节点的数量和位置取决于具体的业务需求和场景。一台服务器可以启动多个哨兵节点，只要保证端口号不冲突即可。但是一般情况下，没有必要在一台服务器上启动多个哨兵节点，因为这样不能提高哨兵的可用性和容错能力，反而会增加服务器的负载和资源消耗。所以建议在不同的服务器上启动哨兵节点，以实现哨兵的分布式部署。

————————————————

版权声明：本文为CSDN博主「红鼻子时代」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。

原文链接：https://blog.csdn.net/weixin_46253270/article/details/131365031
