#### 一、数据库连接与线程的关系

**在实际项目中，数据库连接是很宝贵的资源，以MySQL为例，一台MySQL服务器最大连接数默认是100, 最大可以达到16384。但现实中最多是到200，再多MySQL服务器就承受不住了。因为mysql连接用的是tcp协议，稳定的同时意味着需要消耗更多时间和性能去建立维持连接。为了能最大利用如此宝贵的数据库连接，我们希望数据库连接能被复用而不需要频繁创建，所以利用池化技术建立数据库连接池。**

了解连接池在多线程场景中是如何工作的。 一个连接池包含多个连接对象。我们可以配置池的大小。 当多个线程需要并发访问一个数据库时，它们会从连接池中请求连接对象。 如果池中仍有空闲连接，线程将获取连接对象并开始其数据库操作。线程完成工作后，会将连接返回到池中。 如果池中没有空闲连接，线程将等待另一个线程将连接对象返回到池中<u>。 所以，一个连接在同一时间只能被一个线程所持有，一个线程在同一时间也只能申请到一个连接，官方也不鼓励在多个线程之间共享连接对象</u>

明白了这点之后再看下线程，我们知道一个线程在生命周期内会做很多事情，比如参数校验，权限验证，数值计算，然后持久化结果。其中可能只有持久化结果环节需要访问JDBC数据库连接,其余的时间范围内，JDBC数据库连接 都是空闲状态。所以如果线程整个生命周期中独占JDBC数据库连接的话，那么这个连接空闲率就很高也就变得很浪费，因为一旦占用了数据库连接可以不限次数执行事务SQL请求，增删查改各种sql操作请求都可以执行。为了提高数据库连接的使用率，目前普遍的解决方案是：<u>当线程需要做数据库操作时，才会真正请求获取JDBC数据库连接,线程使用完了之后，立即释放，被释放的JDBC数据库连接等待下次分配使用。</u>

#### 二、多线程访问同一个数据库连接

前面已经说了，数据库连接在同一时间只能被一个线程所持有，线程在申请数据库连接时也是线程安全的。

Java多线程访问同一个java.sql.Connection会导致事务错乱。解决多个线程访问同一个Connection对象时，必须遵循两个基本原则：

- 以资源互斥的方式访问Connection对象；
- 在线程执行结束时，应当最终及时提交(commit)或回滚(rollback)对Connection的影响；不允许存在尚未被提交或者回滚的语句。







参考 ：https://www.fanruan.com/blog/article/304989/